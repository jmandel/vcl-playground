<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VCL: ValueSet Compose Language &mdash; Specification</title>
<style>
:root {
  --bg: #fafafa; --fg: #1a1a2e; --muted: #64748b; --border: #e2e8f0;
  --accent: #2563eb; --accent-light: #dbeafe; --accent-dark: #1e40af;
  --code-bg: #f1f5f9; --note-bg: #fef3c7; --note-border: #f59e0b;
  --font: system-ui, -apple-system, 'Segoe UI', sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace;
}
*, *::before, *::after { box-sizing: border-box; }
body { font-family: var(--font); color: var(--fg); background: var(--bg); margin: 0; line-height: 1.7; font-size: 16px; }
h1, h2, h3, h4 { line-height: 1.3; margin-top: 2.5em; margin-bottom: 0.5em; }
h1 { font-size: 2rem; margin-top: 0; }
h2 { font-size: 1.4rem; border-bottom: 2px solid var(--accent); padding-bottom: 0.25em; }
h3 { font-size: 1.15rem; color: var(--accent-dark); }
a { color: var(--accent); }
.container { max-width: 800px; margin: 0 auto; padding: 2rem 1.5rem; }
code { font-family: var(--mono); font-size: 0.88em; background: var(--code-bg); padding: 0.15em 0.4em; border-radius: 3px; }
pre { background: var(--code-bg); padding: 1em 1.25em; border-radius: 6px; overflow-x: auto; font-family: var(--mono); font-size: 0.85em; line-height: 1.55; }
pre code { background: none; padding: 0; }
table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.92em; }
th, td { padding: 0.5em 0.75em; text-align: left; border-bottom: 1px solid var(--border); }
th { background: var(--code-bg); font-weight: 600; }
td code { white-space: nowrap; }
.note { background: var(--note-bg); border-left: 4px solid var(--note-border); padding: 0.75em 1em; margin: 1em 0;
  border-radius: 0 6px 6px 0; font-size: 0.93em; }
.try-link { font-size: 0.85em; margin-left: 0.5em; }
.try-link::before { content: '\25B6\00A0'; font-size: 0.75em; }
nav { background: white; border-bottom: 1px solid var(--border); padding: 0.5em 1.5em; position: sticky; top: 0; z-index: 100;
  display: flex; gap: 1.5em; flex-wrap: wrap; font-size: 0.82em; }
nav a { text-decoration: none; color: var(--muted); padding: 0.25em 0; white-space: nowrap; }
nav a:hover { color: var(--accent); }

/* Definition lists */
dl { margin: 1em 0; }
dt { font-weight: 600; margin-top: 0.75em; }
dd { margin-left: 1.5em; margin-bottom: 0.5em; }

/* Grammar */
.grammar { background: var(--code-bg); border-radius: 6px; padding: 1em 1.25em; font-family: var(--mono);
  font-size: 0.82em; line-height: 1.65; overflow-x: auto; white-space: pre; }
.grammar .nt { color: #2563eb; } /* non-terminal */
.grammar .t { color: #059669; font-weight: 600; } /* terminal */
.grammar .c { color: #94a3b8; font-style: italic; } /* comment */

/* Side-by-side */
.side-by-side { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin: 1em 0; }
.side-by-side > div { min-width: 0; }
.side-by-side h4 { margin: 0 0 0.25em; font-size: 0.8em; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
@media (max-width: 700px) { .side-by-side { grid-template-columns: 1fr; } }

.subtitle { color: var(--muted); font-size: 0.95em; margin-top: -0.5em; margin-bottom: 2em; }
</style>
</head>
<body>

<nav>
  <a href="#overview">Overview</a>
  <a href="#basics">Basics</a>
  <a href="#structure">Structure</a>
  <a href="#expressions">Expressions</a>
  <a href="#operators">Operators</a>
  <a href="#system-scoping">System Scoping</a>
  <a href="#implicit-uris">Implicit URIs</a>
  <a href="#compose-mapping">Compose Mapping</a>
  <a href="#grammar">Grammar</a>
  <a href="tutorial.html" style="color: var(--accent);">Interactive Tutorial &rarr;</a>
</nav>

<div class="container">

<!-- ================================================================ -->
<section id="overview">
<h1>VCL: ValueSet Compose Language</h1>
<p class="subtitle">A compact syntax for defining FHIR ValueSets</p>

<p>
  ValueSet Compose Language (VCL) is a domain-specific language for defining
  <a href="https://hl7.org/fhir/valueset-definitions.html#ValueSet.compose">ValueSet.compose</a>
  content in a compact, URL-safe textual form. A VCL expression specifies which codes to include in
  (and optionally exclude from) a ValueSet by declaring filters over code system properties,
  navigating relationships between concepts, and composing results with set operations.
</p>
<p>
  VCL works with any FHIR CodeSystem. It is particularly useful for:
</p>
<ul>
  <li><strong>Dynamic ValueSet definitions</strong> &mdash; expressing intensional value sets
    (defined by rules rather than enumerated codes) in a single compact string</li>
  <li><strong>Implicit ValueSet URIs</strong> &mdash; encoding a ValueSet definition directly
    in a URL, enabling ad-hoc <code>$expand</code> requests without pre-registering a ValueSet resource</li>
  <li><strong>Multi-system ValueSets</strong> &mdash; combining codes from multiple code systems
    in a single expression</li>
</ul>
<p>
  Every VCL expression has a direct correspondence to a <code>ValueSet.compose</code> JSON/XML structure.
  VCL does not add capabilities beyond what <code>ValueSet.compose</code> supports; it provides a
  more readable and writable syntax for the same underlying model.
</p>

<div class="note">
  VCL was designed by Michael Lawley (CSIRO) and is formally specified in the
  <a href="https://build.fhir.org/ig/FHIR/ig-guidance/vcl.html">FHIR IG Guidance</a>.
  This page provides an expanded specification with definitions, examples, and links to an
  <a href="tutorial.html">interactive tutorial</a> with a live RxNorm dataset.
</div>
</section>

<!-- ================================================================ -->
<section id="basics">
<h2>Basics</h2>

<h3>Grammar</h3>
<p>
  VCL has a formal grammar defined in <a href="https://www.antlr.org/">ANTLR</a>
  (see <a href="#grammar">Formal Grammar</a>). Conforming implementations <strong>SHALL</strong>
  accept all syntactically valid expressions as defined by this grammar.
</p>

<h3>Whitespace</h3>
<p>
  Spaces and tabs are insignificant and are ignored everywhere except within quoted values.
  Newlines and carriage returns are <strong>not permitted</strong>.
  This ensures VCL expressions are safe for use in single-line contexts such as URL parameters
  and JSON string values.
</p>

<h3>Codes and Quoting</h3>
<p>
  A <strong>code</strong> in VCL is either:
</p>
<ul>
  <li>An <strong>unquoted simple code</strong> (<code>SCODE</code>): starts with an alphanumeric character,
    followed by zero or more alphanumeric characters, hyphens, or underscores.
    Examples: <code>161</code>, <code>SCD</code>, <code>LP15653-6</code></li>
  <li>A <strong>quoted value</strong>: enclosed in double quotes (<code>"</code>) with backslash (<code>\</code>)
    as the escape character. Only <code>"</code> and <code>\</code> may be escaped.
    Examples: <code>"J45.0"</code>, <code>"_ActNoImmunizationReason"</code></li>
</ul>
<p>
  Codes containing characters other than <code>[a-zA-Z0-9_-]</code> <strong>MUST</strong> be quoted.
</p>

<h3>URIs</h3>
<p>
  URIs in VCL must begin with a scheme of one or more ASCII letters followed by a colon.
  Parentheses within URIs <strong>MUST</strong> be percent-encoded (<code>%28</code> / <code>%29</code>)
  because VCL uses parentheses as delimiters for system scoping.
</p>

<h3>Comments</h3>
<p>There is no syntax for comments in VCL.</p>
</section>

<!-- ================================================================ -->
<section id="structure">
<h2>Structure</h2>
<p>
  VCL maps directly to
  <a href="https://build.fhir.org/valueset-definitions.html#ValueSet.compose"><code>ValueSet.compose</code></a>,
  which defines a ValueSet intensionally (by rules) rather than extensionally (by enumeration).
  A <code>compose</code> element contains:
</p>
<ul>
  <li><a href="https://build.fhir.org/valueset-definitions.html#ValueSet.compose.include"><code>include</code></a>
    &mdash; one or more inclusion rules (their union defines the included codes)</li>
  <li><a href="https://build.fhir.org/valueset-definitions.html#ValueSet.compose.exclude"><code>exclude</code></a>
    &mdash; optional exclusion rules (codes matching these are removed from the result)</li>
</ul>
<p>
  Each <code>include</code>/<code>exclude</code> targets a
  <a href="https://build.fhir.org/valueset-definitions.html#ValueSet.compose.include.system"><code>system</code></a>
  and specifies codes via
  <a href="https://build.fhir.org/valueset-definitions.html#ValueSet.compose.include.concept"><code>concept</code></a> (enumerated),
  <a href="https://build.fhir.org/valueset-definitions.html#ValueSet.compose.include.filter"><code>filter</code></a> (property-based rules), or
  <a href="https://build.fhir.org/valueset-definitions.html#ValueSet.compose.include.valueSet"><code>valueSet</code></a> (reference to another ValueSet).
  VCL provides compact syntax for all of these.
</p>
<p>
  A VCL expression specifies:
</p>
<ol>
  <li>An <strong>inclusion rule</strong>: which codes to include</li>
  <li>An optional <strong>exclusion rule</strong>: which codes to remove from the included set</li>
</ol>
<p>
  Both inclusion and exclusion rules are built from <strong>sub-expressions</strong> combined with
  set operations:
</p>
<dl>
  <dt>Conjunction (AND) &mdash; <code>,</code></dt>
  <dd>
    <p>The <strong>intersection</strong> of two or more sub-expressions. A code is included only if it
    satisfies every sub-expression.</p>
    <pre><code>has_ingredient=161, has_dose_form=317541</code></pre>
    <p>Concepts containing acetaminophen <em>and</em> in oral tablet form.
    Maps to multiple <code>filter</code> entries within a single <code>include</code> element.
    <a class="try-link" href="tutorial.html#example=and-ingredient-df">Try it</a></p>
  </dd>

  <dt>Disjunction (OR) &mdash; <code>;</code></dt>
  <dd>
    <p>The <strong>union</strong> of two or more sub-expressions. A code is included if it
    satisfies any sub-expression.</p>
    <pre><code>has_ingredient=161; has_ingredient=5640</code></pre>
    <p>Concepts containing acetaminophen <em>or</em> ibuprofen.
    Maps to separate <code>include</code> elements.
    <a class="try-link" href="tutorial.html#example=or-ingredients">Try it</a></p>
  </dd>

  <dt>Exclusion (MINUS) &mdash; <code>-</code></dt>
  <dd>
    <p><strong>Set subtraction</strong>. Codes matching the right side are removed from the left side result.</p>
    <pre><code>(has_ingredient=161) - (has_ingredient=5489)</code></pre>
    <p>Concepts containing acetaminophen, excluding those also containing hydrocodone.
    The left side maps to <code>compose.include</code>; the right side to <code>compose.exclude</code>.
    <a class="try-link" href="tutorial.html#example=exclusion">Try it</a></p>
  </dd>
</dl>

<h3>Grouping and Precedence</h3>
<p>
  There are <strong>no operator precedence rules</strong> between <code>,</code> and <code>;</code>.
  Parentheses <code>(</code>...<code>)</code> <strong>MUST</strong> be used to group sub-expressions
  when mixing conjunction and disjunction:
</p>
<pre><code>(has_ingredient=161, has_dose_form=317541) ; (has_ingredient=5640, has_dose_form=317541)</code></pre>
<p>
  Acetaminophen oral tablets OR ibuprofen oral tablets. Without parentheses, the grouping is
  ambiguous and implementations <strong>SHOULD</strong> reject it.
</p>
<p>
  Each sub-expression evaluates to a set of codes and is one of:
</p>
<ul>
  <li>A <strong>code literal</strong> &mdash; a single code</li>
  <li>A <strong>wildcard</strong> (<code>*</code>) &mdash; all codes in the code system</li>
  <li>A <strong>filter</strong> &mdash; a property/operator/value triple that selects codes based on properties</li>
  <li>A <strong>ValueSet include</strong> &mdash; reference to another ValueSet</li>
  <li>A <strong>grouped expression</strong> &mdash; a parenthesized sub-expression</li>
</ul>
</section>

<!-- ================================================================ -->
<section id="expressions">
<h2>Expressions</h2>

<h3 id="expr-code">Code Literals</h3>
<p>
  The simplest VCL expression is a code literal. It evaluates to a set containing exactly that one concept
  (if it exists in the code system).
</p>
<pre><code>161</code></pre>
<p>
  Selects the single concept with code <code>161</code>.
  <a class="try-link" href="tutorial.html#example=code-161">Try it</a>
</p>

<h3 id="expr-star">Wildcard</h3>
<p>
  The wildcard <code>*</code> matches all codes in the (scoped) code system.
</p>
<pre><code>*</code></pre>

<h3 id="expr-filter">Filters</h3>
<p>
  A filter selects codes based on the value of a named property. The general form is:
</p>
<pre><code>{property} {operator} {value}</code></pre>
<p>
  Where <code>{property}</code> is the property name (a code), <code>{operator}</code> is one of the
  <a href="#operators">VCL operators</a>, and <code>{value}</code> depends on the operator.
</p>
<p>
  For example, with the <code>=</code> operator:
</p>
<pre><code>has_ingredient = 161</code></pre>
<p>
  Selects all concepts whose <code>has_ingredient</code> property has the value <code>161</code>.
  In RxNorm, this returns drug components (SCDCs) containing acetaminophen.
  <a class="try-link" href="tutorial.html#example=filter-ingredient">Try it</a>
</p>
<p>
  Filters work with both <strong>concept-valued properties</strong> (edges to other concepts in
  the code system) and <strong>literal-valued properties</strong> (string/boolean values):
</p>
<pre><code>TTY = SCD</code></pre>
<p>
  Selects all concepts whose <code>TTY</code> (term type) literal property equals <code>SCD</code>.
  <a class="try-link" href="tutorial.html#example=filter-tty">Try it</a>
</p>
<p>
  Filters map directly to <code>ValueSet.compose.include.filter</code> elements. Each filter
  produces a single <code>filter</code> entry with <code>property</code>, <code>op</code>, and <code>value</code>.
</p>

<h3 id="expr-of">The "of" Operator (Property Navigation)</h3>
<p>
  The <code>.</code> (dot) operator reverses the direction of a filter. Instead of asking
  "which codes have this property value?", it asks "starting from this code, what does this
  property point to?"
</p>
<pre><code>{value} . {property}</code></pre>
<p>
  This corresponds to the FHIR R6 <code>of</code> filter operator, which reverses the
  <code>property</code>/<code>value</code> roles: the left side is the value (starting point)
  and the right side is the property to follow.
</p>
<pre><code>104906.has_tradename</code></pre>
<p>
  Start at concept <code>104906</code> (acetaminophen 24 MG/ML Oral Solution), follow the
  <code>has_tradename</code> relationship outward. Returns all branded versions of that drug.
  <a class="try-link" href="tutorial.html#example=of-tradename">Try it</a>
</p>
<p>
  The value side of <code>.</code> can be any expression that produces a set of codes.
  Curly braces group a sub-expression for multi-hop traversal:
</p>
<pre><code>{104906.has_tradename}.has_ingredient</code></pre>
<p>
  Start at an SCD &rarr; follow <code>has_tradename</code> (yields SBDs) &rarr;
  follow <code>has_ingredient</code> (yields brand names). This chains two navigation steps.
  <a class="try-link" href="tutorial.html#example=of-chained">Try it</a>
</p>
<p>
  The left side of <code>.</code> may also be a code list, wildcard, URI, or filter list:
</p>
<pre><code>{has_ingredient=161, has_dose_form=317541}.has_tradename</code></pre>
<p>
  Find concepts matching both filters, then follow <code>has_tradename</code> on each.
</p>

<h3 id="expr-in">The "in" Operator with Code Lists and Filter Lists</h3>
<p>
  The <code>^</code> (<code>in</code>) operator tests whether a property's value is a member
  of a specified set. The set can be:
</p>

<h4>A code list</h4>
<p>
  A comma-separated list of codes in curly braces. A code list <strong>MUST</strong> contain
  two or more codes.
</p>
<pre><code>has_ingredient ^ {161, 5640, 1191}</code></pre>
<p>
  Concepts whose <code>has_ingredient</code> value is <code>161</code>, <code>5640</code>, or
  <code>1191</code> (acetaminophen, ibuprofen, or aspirin).
  <a class="try-link" href="tutorial.html#example=in-code-list">Try it</a>
</p>

<h4>A filter list (nested query)</h4>
<p>
  A comma-separated list of filters in curly braces. This enables <strong>graph traversal through
  intermediate nodes</strong>: the property must point to a concept that itself matches
  the nested filters.
</p>
<pre><code>consists_of ^ {has_ingredient = 161}</code></pre>
<p>
  Concepts whose <code>consists_of</code> property points to a concept that has
  <code>has_ingredient = 161</code>. In RxNorm: SCDs that consist of a component
  containing acetaminophen.
  <a class="try-link" href="tutorial.html#example=in-filter-list">Try it</a>
</p>
<p>
  Filter lists can nest further:
</p>
<pre><code>consists_of ^ {has_ingredient ^ {has_tradename = 2201670}}</code></pre>
<p>
  SCDs consisting of a component whose ingredient has a specific trade name.
</p>

<h4>A ValueSet URI</h4>
<pre><code>has_ingredient ^ http://example.com/ValueSet/controlled-substances</code></pre>
<p>
  Concepts whose <code>has_ingredient</code> value is a member of the referenced ValueSet.
</p>

<h3 id="expr-vs-include">ValueSet Includes</h3>
<p>
  The <code>^</code> prefix (without a property) includes all codes that are members of a referenced ValueSet:
</p>
<pre><code>^http://hl7.org/fhir/ValueSet/payeetype</code></pre>
<p>
  This maps to <code>ValueSet.compose.include.valueSet</code>.
</p>
</section>

<!-- ================================================================ -->
<section id="operators">
<h2>Operators</h2>
<p>
  VCL filters map to
  <a href="https://build.fhir.org/valueset-definitions.html#ValueSet.compose.include.filter"><code>ValueSet.compose.include.filter</code></a>
  elements. Each filter has three parts:
</p>
<ul>
  <li><strong><code>property</code></strong> &mdash; the code system property to test
    (as declared in <a href="https://build.fhir.org/codesystem-definitions.html#CodeSystem.property"><code>CodeSystem.property</code></a>
    or <a href="https://build.fhir.org/codesystem-definitions.html#CodeSystem.filter"><code>CodeSystem.filter</code></a>)</li>
  <li><strong><code>op</code></strong> &mdash; the comparison operator, drawn from the
    <a href="https://build.fhir.org/codesystem-filter-operator.html"><code>filter-operator</code></a> CodeSystem</li>
  <li><strong><code>value</code></strong> &mdash; the value to compare against</li>
</ul>
<p>
  In VCL, the operator is expressed as a symbol between the property and value:
  <code>property {op-symbol} value</code>. Each VCL symbol maps to a specific
  <a href="https://build.fhir.org/valueset-filter-operator.html"><code>filter-operator</code></a> code.
  For example, VCL <code>has_ingredient=161</code> maps to
  <code>{"property": "has_ingredient", "op": "=", "value": "161"}</code>.
</p>
<table>
  <tr>
    <th>FHIR&nbsp;Operator</th>
    <th>VCL</th>
    <th>Form</th>
    <th>Semantics</th>
  </tr>
  <tr>
    <td><code>=</code></td><td><code>=</code></td>
    <td><code>prop = value</code></td>
    <td>Property value equals the specified code/string.</td>
  </tr>
  <tr>
    <td><code>is-a</code></td><td><code>&lt;&lt;</code></td>
    <td><code>prop &lt;&lt; code</code></td>
    <td>Property value is the specified code or any of its descendants (subsumption).</td>
  </tr>
  <tr>
    <td><code>descendent-of</code></td><td><code>&lt;</code></td>
    <td><code>prop &lt; code</code></td>
    <td>Property value is a strict descendant of the specified code (not including the code itself).</td>
  </tr>
  <tr>
    <td><code>is-not-a</code></td><td><code>~&lt;&lt;</code></td>
    <td><code>prop ~&lt;&lt; code</code></td>
    <td>Property value is NOT the specified code and NOT any of its descendants.</td>
  </tr>
  <tr>
    <td><code>generalizes</code></td><td><code>&gt;&gt;</code></td>
    <td><code>prop &gt;&gt; code</code></td>
    <td>Property value is the specified code or any of its ancestors.</td>
  </tr>
  <tr>
    <td><code>child-of</code></td><td><code>&lt;!</code></td>
    <td><code>prop &lt;! code</code></td>
    <td>Property value is a direct child of the specified code.</td>
  </tr>
  <tr>
    <td><code>descendent-leaf</code></td><td><code>!!&lt;</code></td>
    <td><code>prop !!&lt; code</code></td>
    <td>Property value is a leaf descendant of the specified code (has no children).</td>
  </tr>
  <tr>
    <td><code>in</code></td><td><code>^</code></td>
    <td><code>prop ^ {values}</code></td>
    <td>Property value is a member of the specified set (code list, filter list, or ValueSet).
      See <a href="#expr-in">"in" operator</a>.</td>
  </tr>
  <tr>
    <td><code>not-in</code></td><td><code>~^</code></td>
    <td><code>prop ~^ {values}</code></td>
    <td>Property value is NOT a member of the specified set.</td>
  </tr>
  <tr>
    <td><code>regex</code></td><td><code>/</code></td>
    <td><code>prop / "pattern"</code></td>
    <td>Property value matches the specified regular expression. The pattern <strong>MUST</strong>
      be a quoted string.</td>
  </tr>
  <tr>
    <td><code>exists</code></td><td><code>?</code></td>
    <td><code>prop ? true</code></td>
    <td>Tests whether the property has any value. <code>?true</code> matches concepts
      that have the property; <code>?false</code> matches concepts that lack it.</td>
  </tr>
  <tr>
    <td><code>of</code></td><td><code>.</code></td>
    <td><code>value . prop</code></td>
    <td>Property navigation. Reverses the property/value roles: starts from the value side
      and follows the property. See <a href="#expr-of">"of" operator</a>.</td>
  </tr>
</table>

<div class="note">
  <strong>FHIR R6 features:</strong> The <code>of</code> operator is new in FHIR R6 and does not
  yet appear in the
  <a href="https://build.fhir.org/valueset-filter-operator.html"><code>filter-operator</code></a>
  ValueSet. Additionally, R6 extends <code>in</code>, <code>not-in</code>, and <code>of</code> to
  accept <strong>nested filter lists</strong> as values (not just codes or ValueSet URIs). In earlier
  FHIR versions, the <code>filter.value</code> element is a plain string; nested filters require
  R6's expanded compose model. See <a href="#compose-mapping">Compose Mapping</a> for details.
</div>
</section>

<!-- ================================================================ -->
<section id="system-scoping">
<h2>System Scoping</h2>
<p>
  By default, a VCL expression applies to a single code system (determined by context, e.g.,
  the <code>system</code> element in a <code>ValueSet.compose.include</code>). To explicitly
  scope an expression to a code system, prefix it with the system URI in parentheses:
</p>
<pre><code>(http://www.nlm.nih.gov/research/umls/rxnorm)(has_ingredient = 161)</code></pre>
<p>
  To build a multi-system ValueSet, use disjunction with different system prefixes:
</p>
<pre><code>(http://loinc.org)(SCALE_TYP = Doc) ; (http://snomed.info/sct)(concept &lt;&lt; 404684003)</code></pre>
<p>
  Each system-scoped sub-expression maps to a separate <code>include</code> element
  with its own <code>system</code> value.
</p>
</section>

<!-- ================================================================ -->
<section id="implicit-uris">
<h2>Implicit ValueSet URIs</h2>
<p>
  A VCL expression can be encoded as an <strong>implicit ValueSet URI</strong> &mdash; a URL
  that serves as both identifier and definition for a ValueSet. This enables ad-hoc use
  with <code>$expand</code> without creating a stored ValueSet resource.
</p>

<h3>URL Structure</h3>
<dl>
  <dt>Base URL</dt>
  <dd><code>http://fhir.org/VCL</code></dd>
  <dt>Query parameter</dt>
  <dd><code>?v1=[percent-encoded expression]</code></dd>
</dl>
<p>
  The <code>[expression]</code> portion <strong>MUST</strong> be percent-encoded per RFC 3986.
  Terminology servers processing a VCL implicit ValueSet URL <strong>SHALL</strong> percent-decode
  the expression before interpreting it.
</p>
<p>
  VCL expressions used in implicit URIs <strong>MUST</strong> include
  <a href="#system-scoping">system scoping</a> to identify the target code system(s).
</p>

<h3>Example</h3>
<p>Given the VCL expression:</p>
<pre><code>(http://www.nlm.nih.gov/research/umls/rxnorm)(has_ingredient=161,has_dose_form=317541)</code></pre>
<p>The implicit ValueSet URI is formed by percent-encoding the expression into the <code>v1</code> query parameter:</p>
<pre><code>http://fhir.org/VCL?v1=(http%3A%2F%2Fwww.nlm.nih.gov%2Fresearch%2Fumls%2Frxnorm)(has_ingredient%3D161%2Chas_dose_form%3D317541)</code></pre>
<p>
  Characters that are syntactically significant in a URL query string &mdash; such as <code>:</code>,
  <code>/</code>, <code>=</code>, and <code>,</code> &mdash; are percent-encoded so the expression
  travels safely as a single parameter value.
</p>

<h3>Usage with <code>$expand</code></h3>
<p>
  To expand a VCL implicit ValueSet via
  <a href="https://build.fhir.org/valueset-operation-expand.html"><code>$expand</code></a>,
  pass the implicit URI as the <code>url</code> parameter. Because the implicit URI itself
  contains query-string syntax (<code>?v1=...</code>), it must be percent-encoded again
  when used as a parameter value, producing <strong>double encoding</strong>.
</p>
<p>Using a POST-based <code>$expand</code> with a <code>Parameters</code> resource body avoids
  double encoding &mdash; the implicit URI is sent as-is in the <code>url</code> parameter value.</p>
<p>Example with a GET request:</p>
<pre><code>GET [base]/ValueSet/$expand
  ?url=http%3A%2F%2Ffhir.org%2FVCL%3Fv1%3D
    (http%253A%252F%252F...rxnorm)
    (has_ingredient%253D161%252Chas_dose_form%253D317541)</code></pre>
<p>The server decodes <code>?url=</code> once to recover the implicit URI, then decodes
  <code>?v1=</code> to recover the raw VCL expression.</p>
</section>

<!-- ================================================================ -->
<section id="compose-mapping">
<h2>Mapping to ValueSet.compose</h2>
<p>
  Every VCL expression has a direct structural correspondence to <code>ValueSet.compose</code>.
  This section defines the mapping.
</p>

<h3>Code literal</h3>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>161</code></pre></div>
  <div><h4>compose</h4><pre><code>{"include": [{
  "system": "...",
  "concept": [{"code": "161"}]
}]}</code></pre></div>
</div>

<h3>Single filter</h3>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>has_ingredient = 161</code></pre></div>
  <div><h4>compose</h4><pre><code>{"include": [{
  "system": "...",
  "filter": [{
    "property": "has_ingredient",
    "op": "=",
    "value": "161"
  }]
}]}</code></pre></div>
</div>

<h3>Conjunction (AND)</h3>
<p>Multiple filters within a conjunction map to multiple <code>filter</code> entries
  in a <strong>single</strong> <code>include</code>:</p>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>has_ingredient=161,
has_dose_form=317541</code></pre></div>
  <div><h4>compose</h4><pre><code>{"include": [{
  "system": "...",
  "filter": [
    {"property": "has_ingredient",
     "op": "=", "value": "161"},
    {"property": "has_dose_form",
     "op": "=", "value": "317541"}
  ]
}]}</code></pre></div>
</div>

<h3>Disjunction (OR)</h3>
<p>Each operand in a disjunction maps to a <strong>separate</strong> <code>include</code>:</p>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>has_ingredient=161;
has_ingredient=5640</code></pre></div>
  <div><h4>compose</h4><pre><code>{"include": [
  {"system": "...", "filter": [{
    "property": "has_ingredient",
    "op": "=", "value": "161"}]},
  {"system": "...", "filter": [{
    "property": "has_ingredient",
    "op": "=", "value": "5640"}]}
]}</code></pre></div>
</div>

<h3>Exclusion</h3>
<p>The left side maps to <code>include</code>, the right side to <code>exclude</code>:</p>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>(has_ingredient=161) -
(has_ingredient=5489)</code></pre></div>
  <div><h4>compose</h4><pre><code>{"include": [{
  "system": "...",
  "filter": [{"property": "has_ingredient",
    "op": "=", "value": "161"}]
}],
"exclude": [{
  "system": "...",
  "filter": [{"property": "has_ingredient",
    "op": "=", "value": "5489"}]
}]}</code></pre></div>
</div>

<h3>System scoping</h3>
<p>The system URI prefix maps to the <code>system</code> element in each <code>include</code>/<code>exclude</code>:</p>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>(http://loinc.org)(SCALE_TYP=Doc);
(http://snomed.info/sct)(concept&lt;&lt;404684003)</code></pre></div>
  <div><h4>compose</h4><pre><code>{"include": [
  {"system": "http://loinc.org",
   "filter": [{"property": "SCALE_TYP",
     "op": "=", "value": "Doc"}]},
  {"system": "http://snomed.info/sct",
   "filter": [{"property": "concept",
     "op": "is-a", "value": "404684003"}]}
]}</code></pre></div>
</div>

<h3>ValueSet include</h3>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>^http://hl7.org/fhir/ValueSet/payeetype</code></pre></div>
  <div><h4>compose</h4><pre><code>{"include": [{
  "valueSet": [
    "http://hl7.org/fhir/ValueSet/payeetype"
  ]
}]}</code></pre></div>
</div>

<h3>The "of" operator (single hop)</h3>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>104906 . has_tradename</code></pre></div>
  <div><h4>compose</h4><pre><code>{"include": [{
  "system": "...",
  "filter": [{
    "property": "has_tradename",
    "op": "of",
    "value": "104906"
  }]
}]}</code></pre></div>
</div>

<h3>The "of" operator (chained multi-hop)</h3>
<p>When an <code>of</code> operator has a complex inner expression, the compose output references
a separate ValueSet via a <strong>VCL URL</strong>. The inner expression becomes its own ValueSet,
identified by <code>http://fhir.org/VCL?v1=(system)(expression)</code>.</p>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>{104906 . has_tradename} . has_ingredient</code></pre></div>
  <div><h4>compose (top-level)</h4><pre><code>{"include": [{
  "system": "...",
  "filter": [{
    "property": "has_ingredient",
    "op": "of",
    "value": "http://fhir.org/VCL?v1=(...)(104906.has_tradename)"
  }]
}]}</code></pre></div>
</div>
<div class="side-by-side">
  <div><h4>VCL URL</h4><pre><code>http://fhir.org/VCL?v1=(...)(104906.has_tradename)</code></pre></div>
  <div><h4>compose (dependency)</h4><pre><code>{"include": [{
  "system": "...",
  "filter": [{
    "property": "has_tradename",
    "op": "of",
    "value": "104906"
  }]
}]}</code></pre></div>
</div>

<h3>Nested filter list (in with filter list)</h3>
<p>Similarly, <code>in</code> or <code>not-in</code> with a filter list emits a VCL URL reference
to a separate ValueSet containing the nested expression.</p>
<div class="side-by-side">
  <div><h4>VCL</h4><pre><code>consists_of ^ {has_ingredient = 161}</code></pre></div>
  <div><h4>compose (top-level)</h4><pre><code>{"include": [{
  "system": "...",
  "filter": [{
    "property": "consists_of",
    "op": "in",
    "value": "http://fhir.org/VCL?v1=(...)(has_ingredient=161)"
  }]
}]}</code></pre></div>
</div>
<div class="side-by-side">
  <div><h4>VCL URL</h4><pre><code>http://fhir.org/VCL?v1=(...)(has_ingredient=161)</code></pre></div>
  <div><h4>compose (dependency)</h4><pre><code>{"include": [{
  "system": "...",
  "filter": [{
    "property": "has_ingredient",
    "op": "=",
    "value": "161"
  }]
}]}</code></pre></div>
</div>
<div class="note">
  Complex nested expressions in <code>in</code>, <code>not-in</code>, and chained <code>of</code>
  are represented as references to separate ValueSets identified by VCL URLs
  (<code>http://fhir.org/VCL?v1=(system)(expression)</code>). A VCL-aware terminology server
  resolves these URLs by parsing and evaluating the embedded VCL expression. This approach
  keeps each <code>ValueSet.compose</code> structure flat and compatible with all FHIR versions.
</div>
</section>

<!-- ================================================================ -->
<section id="grammar">
<h2>Formal Grammar</h2>
<p>
  The authoritative VCL grammar, defined in <a href="https://www.antlr.org/">ANTLR 4</a>:
</p>
<div class="grammar"><span class="c">grammar VCL;</span>

<span class="nt">vcl</span>         : <span class="nt">expr</span> EOF ;
<span class="nt">expr</span>        : <span class="nt">subExpr</span> (<span class="nt">conjunction</span> | <span class="nt">disjunction</span> | <span class="nt">exclusion</span> )? ;
<span class="nt">subExpr</span>     : <span class="nt">systemUri</span>? (<span class="nt">simpleExpr</span> | <span class="t">OPEN</span> <span class="nt">expr</span> <span class="t">CLOSE</span>) ;
<span class="nt">conjunction</span> : (<span class="t">COMMA</span> <span class="nt">subExpr</span>)+ ;
<span class="nt">disjunction</span> : (<span class="t">SEMI</span> <span class="nt">subExpr</span>)+ ;
<span class="nt">exclusion</span>   : <span class="t">DASH</span> <span class="nt">subExpr</span> ;
<span class="nt">simpleExpr</span>  : <span class="t">STAR</span> | <span class="nt">code</span> | <span class="nt">filter</span> | <span class="nt">includeVs</span> ;

<span class="nt">includeVs</span>   : <span class="t">IN</span> (<span class="nt">URI</span> | <span class="nt">systemUri</span>) ;
<span class="nt">systemUri</span>   : <span class="t">OPEN</span> <span class="nt">URI</span> <span class="t">CLOSE</span> ;
<span class="nt">filter</span>      : (<span class="nt">property</span>
                ( <span class="t">EQ</span> <span class="nt">code</span>
                | <span class="t">IS_A</span> <span class="nt">code</span>
                | <span class="t">IS_NOT_A</span> <span class="nt">code</span>
                | <span class="t">DESC_OF</span> <span class="nt">code</span>
                | <span class="t">REGEX</span> <span class="nt">str</span>
                | <span class="t">IN</span> (<span class="nt">codeList</span> | <span class="nt">URI</span> | <span class="nt">filterList</span>)
                | <span class="t">NOT_IN</span> (<span class="nt">codeList</span> | <span class="nt">URI</span> | <span class="nt">filterList</span>)
                | <span class="t">GENERALIZES</span> <span class="nt">code</span>
                | <span class="t">CHILD_OF</span> <span class="nt">code</span>
                | <span class="t">DESC_LEAF</span> <span class="nt">code</span>
                | <span class="t">EXISTS</span> <span class="nt">code</span>
                )
              | (<span class="nt">code</span> | <span class="nt">codeList</span> | <span class="t">STAR</span> | <span class="nt">URI</span> | <span class="nt">filterList</span>) <span class="t">DOT</span> <span class="nt">property</span>  <span class="c">// "of" operator</span>
              );
<span class="nt">filterList</span>  : <span class="t">LCRLY</span> <span class="nt">filter</span> (<span class="t">COMMA</span> <span class="nt">filter</span>)* <span class="t">RCRLY</span> ;
<span class="nt">property</span>    : <span class="nt">code</span> ;

<span class="nt">codeList</span>    : <span class="t">LCRLY</span> <span class="nt">code</span> (<span class="t">COMMA</span> <span class="nt">code</span>)+ <span class="t">RCRLY</span> ;
<span class="nt">code</span>        : <span class="t">SCODE</span> | <span class="t">QUOTED_VALUE</span> ;
<span class="nt">str</span>         : <span class="t">QUOTED_VALUE</span> ;

<span class="t">DASH</span>  : <span class="t">'-'</span> ;    <span class="t">OPEN</span>  : <span class="t">'('</span> ;    <span class="t">CLOSE</span> : <span class="t">')'</span> ;
<span class="t">LCRLY</span> : <span class="t">'{'</span> ;    <span class="t">RCRLY</span> : <span class="t">'}'</span> ;
<span class="t">SEMI</span>  : <span class="t">';'</span> ;    <span class="t">COMMA</span> : <span class="t">','</span> ;
<span class="t">DOT</span>   : <span class="t">'.'</span> ;    <span class="t">STAR</span>  : <span class="t">'*'</span> ;

<span class="t">EQ</span>        : <span class="t">'='</span>   ;   <span class="t">IS_A</span>      : <span class="t">'&lt;&lt;'</span>  ;
<span class="t">IS_NOT_A</span>  : <span class="t">'~&lt;&lt;'</span> ;   <span class="t">DESC_OF</span>   : <span class="t">'&lt;'</span>   ;
<span class="t">REGEX</span>     : <span class="t">'/'</span>   ;   <span class="t">IN</span>        : <span class="t">'^'</span>   ;
<span class="t">NOT_IN</span>    : <span class="t">'~^'</span>  ;   <span class="t">GENERALIZES</span> : <span class="t">'&gt;&gt;'</span> ;
<span class="t">CHILD_OF</span>  : <span class="t">'&lt;!'</span>  ;   <span class="t">DESC_LEAF</span>   : <span class="t">'!!&lt;'</span> ;
<span class="t">EXISTS</span>    : <span class="t">'?'</span>   ;

<span class="nt">URI</span>          : [a-zA-Z]+ [:] [a-zA-Z0-9?=:;&amp;_%+\-.@#$^!{}/]+ ;
<span class="nt">SCODE</span>        : [a-zA-Z0-9] [-_a-zA-Z0-9]* ;   <span class="c">// simple codes only</span>
<span class="nt">QUOTED_VALUE</span> : '"' (~["\\] | '\\' ["\\])* '"' ;

<span class="nt">WS</span>           : [ \t]+ -> skip ;   <span class="c">// skip spaces, tabs; newlines not permitted</span>
</div>
</section>

</div><!-- /.container -->
</body>
</html>
